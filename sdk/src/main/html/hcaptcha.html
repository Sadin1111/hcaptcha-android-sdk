<!DOCTYPE HTML>
<html lang="en">
<head>
    <title>hCaptcha Android</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <style>
        * {
            padding: 0;
            margin: 0;
        }
        html {
            height: 100%;
        }
        body {
            display: table;
            width: 100%;
            height: 100%;
            text-align: center;
        }
        #hcaptcha-container {
            margin-top: 5px;
            display: table-cell;
            vertical-align: middle;
        }
        /* overwrite hCaptcha iframe overlay which adds a #FFF background with opacity 0.05 */
        div > div:nth-child(2) {
            opacity: 0 !important;
        }
    </style>
</head>
<body>
<div id="hcaptcha-container"></div>
<script type="text/javascript">
    if (window.JSDI) {
        JSON.parse(window.JSDI.getDebugInfo()).forEach(function (v) { window[v] = true; });
        window.sysDebug = JSON.parse(window.JSDI.getSysDebug());
    }
</script>
<script type="module">
    import { hCaptchaLoader } from 'https://www.unpkg.com/@hcaptcha/loader@@LOADER_VERSION@/dist/index.mjs';

    // Android will inject this bridge object as `JSInterface`
    // Browser is missing it, so we mock it
    var BridgeObject = window.JSInterface || {
        getConfig: function getConfig() {
            return JSON.stringify({
                siteKey: '10000000-ffff-ffff-ffff-000000000001',
                locale: 'ro',
                size: 'compact',
                orientation: 'portrait',
                theme: 'dark',
                sentry: true,
                rqdata: null,
                jsSrc: 'https://js.hcaptcha.com/1/api.js',
                endpoint: null,
                assethost: null,
                imghost: null,
                reportapi: null
            });
        },
        onPass: function onPass(token) {
            return console.log("pass: token ".concat(token));
        },
        onError: function onError(errCode) {
            return console.log("error: code ".concat(errCode));
        },
        onLoaded: function onLoaded() {
            return console.log('cb: api is loaded');
        },
        onOpen: function onOpen() {
            return console.log('cb: challenge is visible');
        }
    };
    var bridgeConfig = JSON.parse(BridgeObject.getConfig());
    /**
     * Called programmatically from HCaptchaWebViewHelper.
     */
    async function resetAndExecute() {
        hcaptcha.reset();
        await execute();
    }
    window.resetAndExecute = resetAndExecute;
    function reset() {
        hcaptcha.reset();
    }

    function getTheme(config) {
        var theme = config.theme;
        var customTheme = config.customTheme;
        if (customTheme) {
            try {
                return JSON.parse(customTheme);
            } catch (e) {
                console.error(e);
                BridgeObject.onError(32);
            }
        }
        return theme;
    }
    function getRenderConfig(config) {
        return {
            sitekey: config.siteKey,
            size: config.size,
            orientation: config.orientation,
            theme: getTheme(config),
            host: config.host || config.siteKey + '.android-sdk.hcaptcha.com',
            callback: function callback(token) {
                console.log("callback");
                return BridgeObject.onPass(token);
            },
            'chalexpired-callback': function chalexpiredCallback() {
                console.log("chalexpired-callback");
                return BridgeObject.onError(15);
            },
            'close-callback': function closeCallback() {
                console.log("close-callback");
                return BridgeObject.onError(30);
            },
            'open-callback': function openCallback() {
                return BridgeObject.onOpen();
            },
            'error-callback': function errorCallback(error) {
                switch(error) {
                    case "rate-limited":
                        return BridgeObject.onError(31);
                    case "network-error":
                        return BridgeObject.onError(7);
                    case "invalid-data":
                        return BridgeObject.onError(8);
                    case "challenge-error":
                        return BridgeObject.onError(9);
                    case "internal-error":
                        return BridgeObject.onError(10);
                    default:
                        // Error not handled? Log it for debugging purposes
                        console.error(error);
                        return BridgeObject.onError(29);
                }
            }
        };
    }
    function getScriptParams(config) {
        return {
            scriptLocation: document.head,
            apihost: config.jsSrc,
            loadAsync: true,
            async: true,
        };
    }
    function getLoaderParams(config) {
        var result = getScriptParams(config);

        result.render = 'explicit';
        result.sentry = config.sentry;
        result.custom = !!config.customTheme;
        result.assethost = config.assethost;
        result.imghost = config.imghost;
        result.reportapi = config.reportapi;
        result.endpoint = config.endpoint;
        result.host = config.host || config.siteKey + '.android-sdk.hcaptcha.com';
        result.recaptchacompat = 'off';
        result.hl = config.locale;
        result.cleanup = true;

        return result;
    }
    var container = document.getElementById("hcaptcha-container");
    container.addEventListener("click", function () {
        if (hcaptcha) {
            // Allows dismissal of checkbox view
            hcaptcha.close();
        } else {
            BridgeObject.onError(30);
        }
    });
    async function execute() {
        try {
            var { response } = await hcaptcha.execute(getScriptParams(bridgeConfig));
            BridgeObject.onPass(response);
        } catch (error) {
            switch(error) {
                case "rate-limited":
                    return BridgeObject.onError(31);
                case "network-error":
                    return BridgeObject.onError(7);
                case "invalid-data":
                    return BridgeObject.onError(8);
                case "challenge-error":
                    return BridgeObject.onError(9);
                case "internal-error":
                    return BridgeObject.onError(10);
                default:
                    // Error not handled? Log it for debugging purposes
                    console.error(error);
                    return BridgeObject.onError(29);
            }
        }
    }
    async function loadApi(config) {
        try {
            window.hcaptcha = await hCaptchaLoader(getLoaderParams(config));
            var renderConfig = getRenderConfig(config);
            hcaptcha.render("hcaptcha-container", renderConfig);
            BridgeObject.onLoaded();
            var rqdata = config.rqdata;
            if (rqdata) {
                hcaptcha.setData({ rqdata: rqdata });
            }
            if (renderConfig.size === 'invisible' && !config.hideDialog) {
                // We want to auto execute in case of `invisible` checkbox.
                // But not in case of `hideDialog` since verification process
                // might be desired to happen at a later time.
                await execute();
            }
        } catch (e) {
            console.error("loadApi error", e);
            BridgeObject.onError(29);
        }
    }
    loadApi(bridgeConfig);
</script>
</body>
</html>
